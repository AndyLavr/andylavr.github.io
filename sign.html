<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Signing a custom kernel for Secure Boot</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<!--html_preserve-->

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="description" content="WIP Patched Kernel kernel distribution with custom settings">
<meta charset="utf-8" />

<link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">
<link rel="icon" href="images/favicon.ico" type="image/x-icon">

<center>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- AdSense_RU -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4314805673333081"
     data-ad-slot="3717696774"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</center>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-115408845-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115408845-3');
</script>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-4314805673333081",
          enable_page_level_ads: true
     });
</script>

<!--/html_preserve-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 60px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 65px;
  margin-top: -65px;
}

.section h2 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h3 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h4 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h5 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h6 {
  padding-top: 65px;
  margin-top: -65px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->





<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://dragon-kernel.pro">Linux WIP Kernel</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="https://dragon-kernel.pro">Main</a>
</li>
<li>
  <a href="https://github.com/Dragon-Team">Source Code</a>
</li>
<li>
  <a href="https://dragon-kernel.pro/lkrg">Security</a>
</li>
<li>
  <a href="https://dragon-kernel.pro/report">Testing report</a>
</li>
<li>
  <a href="https://dragon-kernel.pro/guide">Guide</a>
</li>
<li>
  <a href="https://dragon-kernel.pro/livedvd">Dragon Live DVD/USB</a>
</li>
<li>
  <a href="https://dragon-kernel.pro/licensing">Licensing/Activation</a>
</li>
<li>
  <a href="https://dragon-kernel.pro/about">About</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Signing a custom kernel for Secure Boot</h1>

</div>


<p><a href="https://github.com/RichardLitt/standard-readme"><img src="https://img.shields.io/badge/readme%20style-standard-brightgreen.svg" alt="standard-readme compliant" /></a> <a href="https://en.cryptobadges.io/donate/1KvWrbLhuzk8DSb2Yq2948bMj3uQvVTQCW"><img src="https://en.cryptobadges.io/badge/micro/1KvWrbLhuzk8DSb2Yq2948bMj3uQvVTQCW" alt="Donate with Bitcoin" /></a> <a href="https://en.cryptobadges.io/donate/0xE42f2d4D4aF888Ac784ED26a68E828475A4712Cb"><img src="https://en.cryptobadges.io/badge/micro/0xE42f2d4D4aF888Ac784ED26a68E828475A4712Cb" alt="Donate with Ethereum" /></a></p>
<hr />
<p><a href=""><img src="images/mok.png" alt="mok" /></a></p>
<p>Instructions are for ubuntu, but should work similar for other distros, if they are using shim and grub as bootloader. If your distro is not using shim (e.g. Linux Foundation Preloader), there should be similar steps to complete the signing (e.g. HashTool instead of MokUtil for LF Preloader) or you can install shim to use instead. The ubuntu package for shim is called <code>shim-signed</code>, but please inform yourself on how to install it correctly, so you do not mess up your bootloader.</p>
<p>Since the most recent GRUB2 update (2.02) in Ubuntu, GRUB2 does not load unsigned kernels anymore, as long as Secure Boot is enabled. Users of Ubuntu 18.04+ will be notified during upgrade of the grub-efi package, that this kernel is not signed and the upgrade will abort.</p>
<p>Thus you have three options to solve this problem:</p>
<ol style="list-style-type: decimal">
<li>You sign the kernel yourself.</li>
<li>You use a signed, generic kernel of your distro.</li>
<li>You disable Secure Boot.</li>
</ol>
<p>Since option two and three are not really viable, these are the steps to sign the kernel yourself.</p>
<p>Instructions adapted from <a href="https://blog.ubuntu.com/2017/08/11/how-to-sign-things-for-secure-boot">the Ubuntu Blog</a>. Before following, please backup your /boot/EFI directory, so you can restore everything. Follow these steps on your own risk.</p>
<ol style="list-style-type: decimal">
<li>Create the config to create the signing key, save as mokconfig.cnf:</li>
</ol>
<pre><code># This definition stops the following lines failing if HOME isn&#39;t
# defined.
HOME                    = .
RANDFILE                = $ENV::HOME/.rnd 
[ req ]
distinguished_name      = req_distinguished_name
x509_extensions         = v3
string_mask             = utf8only
prompt                  = no

[ req_distinguished_name ]
countryName             = &lt;YOURcountrycode&gt;
stateOrProvinceName     = &lt;YOURstate&gt;
localityName            = &lt;YOURcity&gt;
0.organizationName      = &lt;YOURorganization&gt;
commonName              = Secure Boot Signing Key
emailAddress            = &lt;YOURemail&gt;

[ v3 ]
subjectKeyIdentifier    = hash
authorityKeyIdentifier  = keyid:always,issuer
basicConstraints        = critical,CA:FALSE
extendedKeyUsage        = codeSigning,1.3.6.1.4.1.311.10.3.6
nsComment               = &quot;OpenSSL Generated Certificate&quot;</code></pre>
<p>Adjust all parts with &lt;YOUR*&gt; to your details.</p>
<ol start="2" style="list-style-type: decimal">
<li>Create the public and private key for signing the kernel:</li>
</ol>
<pre><code>openssl req -config ./mokconfig.cnf \
        -new -x509 -newkey rsa:2048 \
        -nodes -days 36500 -outform DER \
        -keyout &quot;MOK.priv&quot; \
        -out &quot;MOK.der&quot;</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Convert the key also to PEM format (mokutil needs DER, sbsign needs PEM):</li>
</ol>
<pre><code>openssl x509 -in MOK.der -inform DER -outform PEM -out MOK.pem</code></pre>
<ol start="4" style="list-style-type: decimal">
<li>Enroll the key to your shim installation:</li>
</ol>
<pre><code>$ sudo mokutil --import MOK.der</code></pre>
<p>You will be asked for a password, you will just use it to confirm your key selection in the next step, so choose any.</p>
<ol start="5" style="list-style-type: decimal">
<li><p>Restart your system. You will encounter a blue screen of a tool called MOKManager. Select “Enroll MOK” and then “View key”. Make sure it is your key you created in step 2. Afterwards continue the process and you must enter the password which you provided in step 4. Continue with booting your system.</p></li>
<li><p>Verify your key is enrolled via:</p></li>
</ol>
<pre><code>$ sudo mokutil --list-enrolled</code></pre>
<ol start="7" style="list-style-type: decimal">
<li>Sign your installed kernel (it should be at /boot/vmlinuz-[KERNEL-VERSION]-dragon-generic):</li>
</ol>
<pre><code>$ sudo sbsign --key MOK.priv --cert MOK.pem /boot/vmlinuz-[KERNEL-VERSION]-dragon-generic --output /boot/vmlinuz-[KERNEL-VERSION]-dragon-generic.signed</code></pre>
<ol start="8" style="list-style-type: decimal">
<li>Copy the initram of the unsigned kernel, so we also have an initram for the signed one.</li>
</ol>
<pre><code>$ sudo cp /boot/initrd.img-[KERNEL-VERSION]-dragon-generic{,.signed}</code></pre>
<ol start="9" style="list-style-type: decimal">
<li>Update your grub-config</li>
</ol>
<pre><code>$ sudo update-grub</code></pre>
<ol start="10" style="list-style-type: decimal">
<li>Reboot your system and select the signed kernel. If booting works, you can remove the unsigned kernel:</li>
</ol>
<pre><code>$ sudo mv /boot/vmlinuz-[KERNEL-VERSION]-dragon-generic{.signed,}
$ sudo mv /boot/initrd.img-[KERNEL-VERSION]-dragon-generic{.signed,}
$ sudo update-grub</code></pre>
<p>Now your system should run under a signed kernel and upgrading GRUB2 works again. If you want to upgrade the custom kernel, you can sign the new version easily by following above steps again from step seven on. Thus BACKUP the MOK-keys (MOK.der, MOK.pem, MOK.priv).</p>
<hr />
<div id="donate" class="section level2">
<h2>Donate</h2>
<p><a href="https://en.cryptobadges.io/donate/1KvWrbLhuzk8DSb2Yq2948bMj3uQvVTQCW"><img src="https://en.cryptobadges.io/badge/big/1KvWrbLhuzk8DSb2Yq2948bMj3uQvVTQCW" alt="Donate with Bitcoin" /></a> <a href="https://en.cryptobadges.io/donate/0xE42f2d4D4aF888Ac784ED26a68E828475A4712Cb"><img src="https://en.cryptobadges.io/badge/big/0xE42f2d4D4aF888Ac784ED26a68E828475A4712Cb" alt="Donate with Ethereum" /></a></p>
<hr />
</div>

<p>Copyright &copy; 1966-2019 AndyLavr All rights reserved.</p>



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
